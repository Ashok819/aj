<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avalok Vision â€“ Motion Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body{margin:0;background:#020617;color:#fff;font-family:system-ui}
.container{padding:10px;display:flex;flex-direction:column;gap:12px}
.card{background:#0f172a;border-radius:14px;padding:12px}
.card-title{font-size:13px;opacity:.7;margin-bottom:6px}
video{width:100%;height:55vh;object-fit:cover;border-radius:12px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.value{font-size:20px;color:#38bdf8;font-weight:700}
.btn{background:#1e293b;border:none;color:#fff;padding:6px 10px;border-radius:8px}
canvas{position:absolute;top:0;left:0}
</style>
</head>

<body>

<div class="container">

  <!-- CAMERA CARD -->
  <div class="card">
    <div class="card-title">Live Camera</div>
    <video id="cam" autoplay playsinline></video>
    <button class="btn" onclick="startCalibration()">Calibrate 1 Meter</button>
  </div>

  <!-- PEOPLE CARDS -->
  <div id="people" class="grid"></div>

</div>

<canvas id="draw"></canvas>

<script>
const video = document.getElementById("cam");
const canvas = document.getElementById("draw");
const ctx = canvas.getContext("2d");
const peopleDiv = document.getElementById("people");

let model;
let persons = {};
let pixelsPerMeter = null;

/* ---------- CAMERA ---------- */
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}, audio:false
  });
  video.srcObject = stream;
  return new Promise(r=>video.onloadedmetadata=r);
}

/* ---------- CALIBRATION ---------- */
let p1=null, p2=null, calibrating=false;

function startCalibration(){
  calibrating=true;
  p1=p2=null;
  alert("Draw a line representing 1 meter");
}

canvas.addEventListener("mousedown",e=>{
  if(!calibrating) return;
  p1={x:e.offsetX,y:e.offsetY};
});
canvas.addEventListener("mouseup",e=>{
  if(!calibrating) return;
  p2={x:e.offsetX,y:e.offsetY};
  const d=Math.hypot(p2.x-p1.x,p2.y-p1.y);
  pixelsPerMeter=d;
  calibrating=false;
  alert("Calibration complete");
});

function drawLine(){
  if(p1&&calibrating){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle="red";
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(event.offsetX,event.offsetY);
    ctx.stroke();
  }
}

/* ---------- SPEED + ACTION ---------- */
function kmh(prev,curr,dt){
  if(!pixelsPerMeter) return 0;
  const px=Math.hypot(curr.x-prev.x,curr.y-prev.y);
  return ((px/pixelsPerMeter)/dt)*3.6;
}
function action(speed){
  if(speed<1) return "Standing";
  if(speed<6) return "Walking";
  return "Running";
}

/* ---------- MAIN LOOP ---------- */
async function detect(time){
  const preds = await model.detect(video);
  peopleDiv.innerHTML="";

  preds.filter(p=>p.class==="person").forEach((p,i)=>{
    const [x,y,w,h]=p.bbox;
    const c={x:x+w/2,y:y+h/2};

    if(!persons[i]) persons[i]={prev:c,time};

    const dt=(time-persons[i].time)/1000;
    const speed=kmh(persons[i].prev,c,dt);

    persons[i]={prev:c,time};

    peopleDiv.innerHTML+=`
      <div class="card">
        <div class="card-title">Person ${i+1}</div>
        <div class="value">${speed.toFixed(2)} km/hr</div>
        <div>${action(speed)}</div>
      </div>`;
  });

  requestAnimationFrame(detect);
}

/* ---------- INIT ---------- */
(async()=>{
  await startCamera();
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  model=await cocoSsd.load();
  requestAnimationFrame(detect);
})();
</script>

</body>
</html>
